<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gci.schedule.driverless.mapper.RouteWasteTimeMapper">
  <resultMap id="BaseResultMap" type="com.gci.schedule.driverless.bean.scheduleD.RouteWasteTime">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 26 14:53:41 CST 2019.
    -->
    <result column="ROUTE_ID" jdbcType="DECIMAL" property="routeId" />
    <result column="RUN_DAY_NUM" jdbcType="VARCHAR" property="runDayNum" />
    <result column="DIRECTION" jdbcType="VARCHAR" property="direction" />
    <result column="RUN_TIME_NUM" jdbcType="DECIMAL" property="runTimeNum" />
    <result column="WASTE_TIME" jdbcType="DECIMAL" property="wasteTime" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 26 14:53:41 CST 2019.
    -->
    ROUTE_ID, RUN_DAY_NUM, DIRECTION, RUN_TIME_NUM, WASTE_TIME
  </sql>
  <insert id="insertWasteTime">
    insert into REP_ROUTE_WASTE_TIME(route_id,run_day_num,direction,run_time_num,waste_time,update_time)
    <foreach collection="list" index="index" item="item" separator="union all">
      select
      #{item.routeId,jdbcType=INTEGER},#{item.runDayNum,jdbcType=INTEGER},#{item.direction,jdbcType=INTEGER},
      #{item.runTimeNum,jdbcType=INTEGER},#{item.wasteTime,jdbcType=INTEGER},sysdate
      from dual
    </foreach>
  </insert>
    <insert id="insertWasteTimeHis">
    insert into REP_ROUTE_WASTE_TIME_HIS(route_id,run_day_num,direction,run_time_num,waste_time,update_time)
    <foreach collection="list" index="index" item="item" separator="union all">
        select
        #{item.routeId,jdbcType=INTEGER},#{item.runDayNum,jdbcType=INTEGER},#{item.direction,jdbcType=INTEGER},
        #{item.runTimeNum,jdbcType=INTEGER},#{item.wasteTime,jdbcType=INTEGER},sysdate
        from dual
    </foreach>
    </insert>
    <delete id="delete">
    delete from REP_ROUTE_WASTE_TIME
    <where>
    <if test="routeId != null">
        and ROUTE_ID=#{routeId, jdbcType=DECIMAL}
    </if>
    </where>
  </delete>

  <select id="queryByRoute" resultMap="BaseResultMap">
    select t.*
    from REP_ROUTE_WASTE_TIME T
    where t.route_id = #{routeId,jdbcType=DECIMAL}
    and t.run_day_num = to_char(#{planDate,jdbcType=TIMESTAMP}, 'D') order by t.direction,t.run_time_num
  </select>

  <select id="queryByRouteHistory" resultMap="BaseResultMap">
    select direction,run_time_num,floor(avg(run_duration)) waste_time from (
		select t.run_duration,t.direction,floor((t.triplog_begin_time-t.run_date)*1440/15) run_time_num 
		from apts.dy_triplog t where t.run_date=#{runDate,jdbcType=TIMESTAMP} and t.service_type=1 and t.route_id_run=#{routeId,jdbcType=DECIMAL}
		and t.run_duration is not null and exists (select 1 from apts.bs_routesub r where r.service_type=1 and r.direction=t.direction and 
		t.from_station_id=r.first_station_id and t.to_station_id=r.last_station_id)
	)group by direction,run_time_num
  </select>
  
  <select id="queryHistoryRunDate" resultType="java.util.Date">
  	select max(t.run_date) run_date_ref
		  from apts.dy_triplog t
		 where t.run_date between trunc(sysdate - 365) and trunc(sysdate - 1)
		   and t.route_id_run = #{routeId,jdbcType=DECIMAL}
		   and t.service_type = 1
		   and exists (select 1
		          from apts.bs_route r
		         where r.route_id = t.route_id_run
		           and t.from_station_id = r.first_station_id
		           and t.to_station_id = r.last_station_id)
  </select>

  <select id="queryByRouteIdAndRunDayNum" resultMap="BaseResultMap">
    select t.*
    from REP_ROUTE_WASTE_TIME T
    where t.route_id = #{routeId,jdbcType=DECIMAL}
    and t.run_day_num = #{weekday,jdbcType=DECIMAL}
  </select>
    
  <select id="queryByRouteIdAndRunDayAndDirection" resultMap="BaseResultMap">
    select t.*
    from REP_ROUTE_WASTE_TIME T
    where t.route_id = #{routeId,jdbcType=DECIMAL}
    and t.run_day_num = #{weekday,jdbcType=DECIMAL}
    and t.direction = #{direction,jdbcType=DECIMAL}
  </select>
</mapper>