<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gci.schedule.driverless.mapper.DySchedulePlanDriverlessMapper">
  <resultMap id="BaseResultMap" type="com.gci.schedule.driverless.bean.scheduleD.DySchedulePlanDriverless">
    <result column="SCHEDULE_ID" jdbcType="DECIMAL" property="scheduleId" />
    <result column="ROUTE_ID" jdbcType="DECIMAL" property="routeId" />
    <result column="ROUTE_CODE" jdbcType="VARCHAR" property="routeCode" />
    <result column="PLAN_DATE" jdbcType="TIMESTAMP" property="planDate" />
    <result column="PLAN_TIME" jdbcType="TIMESTAMP" property="planTime" />
    <result column="START_DIRECTION" jdbcType="VARCHAR" property="startDirection" />
    <result column="START_ORDER_NUMBER" jdbcType="DECIMAL" property="startOrderNumber" />
    <result column="TRIP_END_TIME" jdbcType="TIMESTAMP" property="tripEndTime" />
    <result column="SERVICE_TYPE" jdbcType="VARCHAR" property="serviceType" />
    <result column="SERVICE_NAME" jdbcType="VARCHAR" property="serviceName" />
    <result column="DIRECTION" jdbcType="VARCHAR" property="direction" />
    <result column="BUS_CODE" jdbcType="VARCHAR" property="busCode" />
    <result column="BUS_ID" jdbcType="DECIMAL" property="busId" />
    <result column="BUS_NAME" jdbcType="VARCHAR" property="busName" />
    <result column="FIRST_ROUTE_STA_ID" jdbcType="DECIMAL" property="firstRouteStaId" />
    <result column="LAST_ROUTE_STA_ID" jdbcType="DECIMAL" property="lastRouteStaId" />
    <result column="FIRST_ROUTE_STA_NAME" jdbcType="VARCHAR" property="firstRouteStaName" />
    <result column="LAST_ROUTE_STA_NAME" jdbcType="VARCHAR" property="lastRouteStaName" />
    <result column="RUN_MILEAGE" jdbcType="DECIMAL" property="runMileage" />
    <result column="PEAK_TYPE" jdbcType="VARCHAR" property="peakType" />
    <result column="FIRST_ROUND_PLAN_TIME" jdbcType="TIMESTAMP" property="firstRoundPlanTime" />
    <result column="FIRST_ROUND_TASK_ID" jdbcType="DECIMAL" property="firstRoundTaskId" />
    <result column="SYNC_PLAN" jdbcType="DECIMAL" property="syncPlan" />
    <result column="CLASSES" jdbcType="DECIMAL" property="classes" />
    <result column="SUPPORT_CLASSES" jdbcType="DECIMAL" property="supportClasses" />
    <result column="INTERVAL" jdbcType="DECIMAL" property="interval" />
    <result column="STOP_TIME" jdbcType="DECIMAL" property="stopTime" />
    <result column="PASSENGER_NUM" jdbcType="DECIMAL" property="passengerNum" />
    <result column="PASSENGER_DATE" jdbcType="TIMESTAMP" property="passengerData" />
    <result column="SUPPORT_ROUTE_ID" jdbcType="DECIMAL" property="supportRouteId" />
    <result column="BUS_NAME_Full" jdbcType="VARCHAR" property="busNameFull"/>
    <result column="STATUS" jdbcType="DECIMAL" property="status" />
    <result column="FULL_TIME" jdbcType="DECIMAL" property="fullTime" />
  </resultMap>
  <insert id="insert" parameterType="com.gci.schedule.driverless.bean.scheduleD.DySchedulePlanDriverless">
    insert into DY_SCHEDULE_PLAN_DRIVERLESS (SCHEDULE_ID, ROUTE_ID, ROUTE_CODE, 
      PLAN_DATE, PLAN_TIME, START_DIRECTION, 
      START_ORDER_NUMBER, TRIP_END_TIME, SERVICE_TYPE, 
      SERVICE_NAME, DIRECTION, BUS_CODE, 
      BUS_ID, BUS_NAME, FIRST_ROUTE_STA_ID,
      LAST_ROUTE_STA_ID, FIRST_ROUTE_STA_NAME, LAST_ROUTE_STA_NAME, 
      RUN_MILEAGE, PEAK_TYPE, FIRST_ROUND_PLAN_TIME,
      FIRST_ROUND_TASK_ID, SYNC_PLAN,CLASSES,SUPPORT_CLASSES,INTERVAL,STOP_TIME,PASSENGER_NUM,
      PASSENGER_DATE,SUPPORT_ROUTE_ID,STATUS,FULL_TIME)
    values (SEQ_SCHEDULE_PLAN_DRIVERLESS.nextval, #{routeId,jdbcType=DECIMAL}, #{routeCode,jdbcType=VARCHAR},
      #{planDate,jdbcType=TIMESTAMP}, #{planTime,jdbcType=TIMESTAMP}, #{startDirection,jdbcType=VARCHAR}, 
      #{startOrderNumber,jdbcType=DECIMAL}, #{tripEndTime,jdbcType=TIMESTAMP}, #{serviceType,jdbcType=VARCHAR}, 
      #{serviceName,jdbcType=VARCHAR}, #{direction,jdbcType=VARCHAR}, #{busCode,jdbcType=VARCHAR}, 
      #{busId,jdbcType=DECIMAL}, #{busName,jdbcType=VARCHAR}, #{firstRouteStaId,jdbcType=DECIMAL}, 
      #{lastRouteStaId,jdbcType=DECIMAL}, #{firstRouteStaName,jdbcType=VARCHAR}, #{lastRouteStaName,jdbcType=VARCHAR}, 
      #{runMileage,jdbcType=DECIMAL}, #{peakType,jdbcType=VARCHAR}, #{firstRoundPlanTime,jdbcType=TIMESTAMP}, 
      #{firstRoundTaskId,jdbcType=DECIMAL}, #{syncPlan,jdbcType=DECIMAL},#{classes,jdbcType=DECIMAL},#{supportClasses,jdbcType=DECIMAL},
      #{interval,jdbcType=DECIMAL},#{stopTime,jdbcType=DECIMAL},#{passengerNum,jdbcType=DECIMAL},#{passengerData,jdbcType=TIMESTAMP},
      #{supportRouteId,jdbcType=DECIMAL},#{status,jdbcType=DECIMAL},#{fullTime,jdbcType=DECIMAL})
  </insert>
  <insert id="batchInsertSchedule">
    insert into DY_SCHEDULE_PLAN_DRIVERLESS (SCHEDULE_ID, ROUTE_ID, ROUTE_CODE,
    PLAN_DATE, PLAN_TIME, START_DIRECTION,
    START_ORDER_NUMBER, TRIP_END_TIME, SERVICE_TYPE,
    SERVICE_NAME, DIRECTION, BUS_CODE,
    BUS_ID, BUS_NAME, FIRST_ROUTE_STA_ID,
    LAST_ROUTE_STA_ID, FIRST_ROUTE_STA_NAME, LAST_ROUTE_STA_NAME,
    RUN_MILEAGE, PEAK_TYPE, FIRST_ROUND_PLAN_TIME,
    FIRST_ROUND_TASK_ID, SYNC_PLAN)

    select t.* from
    (
    <foreach collection="list" index="index" item="item" separator="union all">
      select
      SEQ_SCHEDULE_PLAN_DRIVERLESS.nextval,#{item.routeId,jdbcType=DECIMAL},#{item.routeCode,jdbcType=VARCHAR},#{item.planDate,jdbcType=TIMESTAMP},#{item.planTime,jdbcType=TIMESTAMP},#{item.startDirection,jdbcType=VARCHAR},
      #{item.startOrderNumber,jdbcType=DECIMAL},#{item.tripEndTime,jdbcType=TIMESTAMP},#{item.serviceType,jdbcType=VARCHAR},#{item.serviceName,jdbcType=VARCHAR},#{item.direction,jdbcType=VARCHAR},
      #{item.busCode,jdbcType=VARCHAR},#{item.busId,jdbcType=DECIMAL},#{item.busName,jdbcType=VARCHAR},#{item.firstRouteStaId,jdbcType=DECIMAL},#{item.lastRouteStaId,jdbcType=DECIMAL},
      #{item.firstRouteStaName,jdbcType=VARCHAR},#{item.lastRouteStaName,jdbcType=VARCHAR},#{item.runMileage,jdbcType=DECIMAL},#{item.peakType,jdbcType=VARCHAR},#{item.firstRoundPlanTime,jdbcType=TIMESTAMP},
      #{item.firstRoundTaskId,jdbcType=DECIMAL},#{item.syncPlan,jdbcType=DECIMAL}
      from dual
    </foreach>
    ) t
  </insert>
  <insert id="insertSelective" parameterType="com.gci.schedule.driverless.bean.scheduleD.DySchedulePlanDriverless">
    insert into DY_SCHEDULE_PLAN_DRIVERLESS
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="scheduleId != null">
        SCHEDULE_ID,
      </if>
      <if test="routeId != null">
        ROUTE_ID,
      </if>
      <if test="routeCode != null">
        ROUTE_CODE,
      </if>
      <if test="planDate != null">
        PLAN_DATE,
      </if>
      <if test="planTime != null">
        PLAN_TIME,
      </if>
      <if test="startDirection != null">
        START_DIRECTION,
      </if>
      <if test="startOrderNumber != null">
        START_ORDER_NUMBER,
      </if>
      <if test="tripEndTime != null">
        TRIP_END_TIME,
      </if>
      <if test="serviceType != null">
        SERVICE_TYPE,
      </if>
      <if test="serviceName != null">
        SERVICE_NAME,
      </if>
      <if test="direction != null">
        DIRECTION,
      </if>
      <if test="busCode != null">
        BUS_CODE,
      </if>
      <if test="busId != null">
        BUS_ID,
      </if>
      <if test="busName != null">
        BUS_NAME,
      </if>
      <if test="firstRouteStaId != null">
        FIRST_ROUTE_STA_ID,
      </if>
      <if test="lastRouteStaId != null">
        LAST_ROUTE_STA_ID,
      </if>
      <if test="firstRouteStaName != null">
        FIRST_ROUTE_STA_NAME,
      </if>
      <if test="lastRouteStaName != null">
        LAST_ROUTE_STA_NAME,
      </if>
      <if test="runMileage != null">
        RUN_MILEAGE,
      </if>
      <if test="peakType != null">
        PEAK_TYPE,
      </if>
      <if test="firstRoundPlanTime != null">
        FIRST_ROUND_PLAN_TIME,
      </if>
      <if test="firstRoundTaskId != null">
        FIRST_ROUND_TASK_ID,
      </if>
      <if test="syncPlan != null">
        SYNC_PLAN,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="scheduleId != null">
        #{scheduleId,jdbcType=DECIMAL},
      </if>
      <if test="routeId != null">
        #{routeId,jdbcType=DECIMAL},
      </if>
      <if test="routeCode != null">
        #{routeCode,jdbcType=VARCHAR},
      </if>
      <if test="planDate != null">
        #{planDate,jdbcType=TIMESTAMP},
      </if>
      <if test="planTime != null">
        #{planTime,jdbcType=TIMESTAMP},
      </if>
      <if test="startDirection != null">
        #{startDirection,jdbcType=VARCHAR},
      </if>
      <if test="startOrderNumber != null">
        #{startOrderNumber,jdbcType=DECIMAL},
      </if>
      <if test="tripEndTime != null">
        #{tripEndTime,jdbcType=TIMESTAMP},
      </if>
      <if test="serviceType != null">
        #{serviceType,jdbcType=VARCHAR},
      </if>
      <if test="serviceName != null">
        #{serviceName,jdbcType=VARCHAR},
      </if>
      <if test="direction != null">
        #{direction,jdbcType=VARCHAR},
      </if>
      <if test="busCode != null">
        #{busCode,jdbcType=VARCHAR},
      </if>
      <if test="busId != null">
        #{busId,jdbcType=DECIMAL},
      </if>
      <if test="busName != null">
        #{busName,jdbcType=VARCHAR},
      </if>
      <if test="firstRouteStaId != null">
        #{firstRouteStaId,jdbcType=DECIMAL},
      </if>
      <if test="lastRouteStaId != null">
        #{lastRouteStaId,jdbcType=DECIMAL},
      </if>
      <if test="firstRouteStaName != null">
        #{firstRouteStaName,jdbcType=VARCHAR},
      </if>
      <if test="lastRouteStaName != null">
        #{lastRouteStaName,jdbcType=VARCHAR},
      </if>
      <if test="runMileage != null">
        #{runMileage,jdbcType=DECIMAL},
      </if>
      <if test="peakType != null">
        #{peakType,jdbcType=VARCHAR},
      </if>
      <if test="firstRoundPlanTime != null">
        #{firstRoundPlanTime,jdbcType=TIMESTAMP},
      </if>
      <if test="firstRoundTaskId != null">
        #{firstRoundTaskId,jdbcType=DECIMAL},
      </if>
      <if test="syncPlan != null">
        #{syncPlan,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  <select id="getScheduleList" parameterType="com.gci.schedule.driverless.bean.scheduleD.DySchedulePlanDriverless" resultMap="BaseResultMap">
    select * from DY_SCHEDULE_PLAN_DRIVERLESS
    where route_id = #{routeId,jdbcType=DECIMAL} and support_route_id = #{supportRouteId,jdbcType=DECIMAL} and plan_date = #{planDate,jdbcType=TIMESTAMP} order by plan_time desc
  </select>

  <select id="getScheduleList02" parameterType="com.gci.schedule.driverless.bean.scheduleD.DySchedulePlanDriverless" resultMap="BaseResultMap">
    select * from DY_SCHEDULE_PLAN_DRIVERLESS
    where route_id = #{routeId,jdbcType=DECIMAL} and plan_date = #{planDate,jdbcType=TIMESTAMP}
    <if test="status != null">
    and status = #{status,jdbcType=DECIMAL}
    </if>
    order by plan_time desc
  </select>

  <select id="selectSchedulePlan" resultMap="BaseResultMap" parameterType="map">
        select schedule_id
             , route_id
             , route_code
             , plan_date
             , plan_time
             , start_direction
             , start_order_number
             , trip_end_time
             , service_type
             , service_name
             , direction
             , bus_code
             , bus_id
             , bus_name
             , (decode(p.start_direction, 0, '上', 1, '下', '') || p.start_order_number) as bus_name_full
             , FIRST_ROUTE_STA_ID
             , LAST_ROUTE_STA_ID
        from DY_SCHEDULE_PLAN_DRIVERLESS p
        where P.route_id = #{routeId,jdbcType=DECIMAL}
          and p.trip_end_time >= #{runDate,jdbcType=TIMESTAMP}
          and p.plan_time &lt;= #{runDate,jdbcType=TIMESTAMP} + 1 / 24
          and p.STATUS = #{scheduleStatus,jdbcType=DECIMAL}
    </select>

  <select id="getMinPlanTimeByRouteIdAndPlanDate" resultType="java.util.Date">
        select min(plan_time)
        from DY_SCHEDULE_PLAN_DRIVERLESS
        where route_id = #{routeId}
          and plan_date = #{date}
        order by plan_time
    </select>

  <resultMap id="BusConfigureMap" type="com.gci.schedule.driverless.bean.scheduleD.BusConfigure">
    <result property="busNumber" jdbcType="BIGINT" column="BUS_NUMBER"></result>
    <result property="singleBusNumber" jdbcType="BIGINT" column="SINGLE_BUS_NUMBER"></result>
  </resultMap>

  <select id="busConfigure" resultMap="BusConfigureMap">
        select * from
        (
        select count(1) as BUS_NUMBER from
        (select distinct t.start_direction,t.start_order_number from DY_SCHEDULE_PLAN_DRIVERLESS t
        where t.ROUTE_ID = #{routeId,jdbcType=VARCHAR} and status = #{status,jdbcType=DECIMAL}
        and trunc(t.PLAN_DATE) = trunc(to_date( #{runDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss')))
        ) aa,
        (
        select count(1) as SINGLE_BUS_NUMBER from
        (select distinct t.start_direction,t.start_order_number from DY_SCHEDULE_PLAN_DRIVERLESS t
        where t.ROUTE_ID = #{routeId,jdbcType=VARCHAR} and status = #{status,jdbcType=DECIMAL}
        and trunc(t.PLAN_DATE) = trunc(to_date( #{runDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss'))
        and t.SERVICE_TYPE=-32)
        ) bb
    </select>
</mapper>