<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gci.schedule.driverless.dynamic.mapper.RouteWasteTimeDynamicMapper">
  <resultMap id="BaseResultMap" type="com.gci.schedule.driverless.dynamic.bean.RouteWasteTime">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 26 14:53:41 CST 2019.
    -->
    <result column="ROUTE_ID" jdbcType="DECIMAL" property="routeId" />
    <result column="RUN_DAY_NUM" jdbcType="VARCHAR" property="runDayNum" />
    <result column="DIRECTION" jdbcType="VARCHAR" property="direction" />
    <result column="RUN_TIME_NUM" jdbcType="DECIMAL" property="runTimeNum" />
    <result column="WASTE_TIME" jdbcType="DECIMAL" property="wasteTime" />
  </resultMap>

  <select id="queryByRoute" resultMap="BaseResultMap">
    select t.*
    from REP_ROUTE_WASTE_TIME T
    where t.route_id = #{routeId,jdbcType=DECIMAL}
    and t.run_day_num = to_char(#{planDate,jdbcType=TIMESTAMP}, 'D') order by t.direction,t.run_time_num
  </select>

  <select id="queryByRouteHistory" resultMap="BaseResultMap">
    select direction,run_time_num,floor(avg(run_duration)) waste_time from (
		select t.run_duration,t.direction,floor((t.triplog_begin_time-t.run_date)*1440/15) run_time_num 
		from apts.dy_triplog t where t.run_date=#{runDate,jdbcType=TIMESTAMP} and t.service_type=1 and t.route_id_run=#{routeId,jdbcType=DECIMAL}
		and t.run_duration is not null and exists (select 1 from apts.bs_routesub r where r.service_type=1 and r.direction=t.direction and 
		t.from_station_id=r.first_station_id and t.to_station_id=r.last_station_id)
	)group by direction,run_time_num
  </select>
  
  <select id="queryHistoryRunDate" resultType="java.util.Date">
  	select max(t.run_date) run_date_ref
		  from apts.dy_triplog t
		 where t.run_date between trunc(sysdate - 365) and trunc(sysdate - 1)
		   and t.route_id_run = #{routeId,jdbcType=DECIMAL}
		   and t.service_type = 1
		   and exists (select 1
		          from apts.bs_route r
		         where r.route_id = t.route_id_run
		           and t.from_station_id = r.first_station_id
		           and t.to_station_id = r.last_station_id)
  </select>
</mapper>